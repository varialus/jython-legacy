package org.python.util.install;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.text.MessageFormat;
import java.util.Date;

public class StartScriptGenerator {

    protected final static int UNIX_FLAVOUR = 10;
    protected final static int WINDOWS_FLAVOUR = 30;

    private final static String EXECUTABLE_MODE = "755";

    private final static String JYTHON = "jython";
    private final static String JYTHON_BAT = "jython.bat";
    private final static String JYTHONC = "jythonc";
    private final static String JYTHONC_BAT = "jythonc.bat";
    private final static String JYTHON_JAR = JarInstaller.JYTHON_JAR;

    private File _targetDirectory;
    private File _javaHome;
    private int _flavour;

    public StartScriptGenerator(File targetDirectory, File javaHome) {
        _targetDirectory = targetDirectory;
        _javaHome = javaHome;
        if (Installation.isWindows()) {
            setFlavour(WINDOWS_FLAVOUR);
        } else {
            // everything else defaults to unix at the moment
            setFlavour(UNIX_FLAVOUR);
        }
    }

    protected void setFlavour(int flavour) {
        _flavour = flavour;
    }

    protected int getFlavour() {
        return _flavour;
    }

    protected final void generateStartScripts() throws IOException {
        generateJythonScript();
        generateJythoncScript();
    }

    private final void generateJythonScript() throws IOException {
        if (getFlavour() == WINDOWS_FLAVOUR) {
            writeToFile(JYTHON_BAT, getJythonScript());
        } else {
            makeExecutable(writeToFile(JYTHON, getJythonScript()));
        }
    }

    private final void generateJythoncScript() throws IOException {
        if (getFlavour() == WINDOWS_FLAVOUR) {
            writeToFile(JYTHONC_BAT, getJythoncScript());
        } else {
            makeExecutable(writeToFile(JYTHONC, getJythoncScript()));
        }
    }

    /**
     * only <code>protected</code> for unit test use
     */
    protected final String getJythonScript() throws IOException {
        if (getFlavour() == WINDOWS_FLAVOUR) {
            return getStartScript(getWindowsJythonTemplate());
        } else {
            return getStartScript(getUnixJythonTemplate());
        }
    }

    /**
     * only <code>protected</code> for unit test use
     */
    protected final String getJythoncScript() throws IOException {
        if (getFlavour() == WINDOWS_FLAVOUR) {
            return getStartScript(getWindowsJythoncTemplate());
        } else {
            return getStartScript(getUnixJythoncTemplate());
        }
    }

    /**
     * These placeholders are valid for all private methods:
     * 
     * {0} : current date <br>
     * {1} : user.name <br>
     * {2} : java home directory <br>
     * {3} : target directory <br>
     */
    private String getStartScript(String template) throws IOException {
        String parameters[] = new String[4];
        parameters[0] = new Date().toString();
        parameters[1] = System.getProperty("user.name");
        parameters[2] = _javaHome.getCanonicalPath();
        parameters[3] = _targetDirectory.getCanonicalPath();
        return MessageFormat.format(template, parameters);
    }

    /**
     * placeholders:
     * 
     * @see getStartScript
     */
    private String getWindowsJythonTemplate() {
        StringBuffer buffer = getWindowsHeaderTemplate();
        buffer.append("\"{2}\\bin\\java.exe\" -Dpython.home=\"{3}\" -classpath \"{3}\\" + JYTHON_JAR + ";%CLASSPATH%\" org.python.util.jython %ARGS%\n");
        return buffer.toString();
    }

    /**
     * placeholders:
     * 
     * @see getStartScript
     */
    private String getWindowsJythoncTemplate() {
        StringBuffer buffer = getWindowsHeaderTemplate();
        buffer.append("\"{3}\\jython.bat\" \"{3}\\Tools\\jythonc\\jythonc.py\" %ARGS%\n");
        return buffer.toString();
    }

    /**
     * placeholders:
     * 
     * @see getStartScript
     */
    private StringBuffer getWindowsHeaderTemplate() {
        StringBuffer buffer = new StringBuffer(1000);
        buffer.append("@echo off\n");
        buffer.append("rem This file was generated by the Jython installer\n");
        buffer.append("rem Created on {0} by {1}\n");
        buffer.append("\n");
        buffer.append("set ARGS=\n");
        buffer.append("\n");
        buffer.append(":loop\n");
        buffer.append("if [%1] == [] goto end\n");
        buffer.append("    set ARGS=%ARGS% %1\n");
        buffer.append("    shift\n");
        buffer.append("    goto loop\n");
        buffer.append(":end\n");
        buffer.append("\n");
        return buffer;
    }

    /**
     * placeholders:
     * 
     * @see getStartScript
     */
    private String getUnixJythonTemplate() {
        StringBuffer buffer = getUnixHeaderTemplate();
        buffer.append("CP={3}/" + JYTHON_JAR + "\n");
        buffer.append("if [ ! -z \"$CLASSPATH\" ]\nthen\n  CP=$CP:$CLASSPATH\nfi\n");
        buffer.append("\"{2}/bin/java\" -Dpython.home=\"{3}\" -classpath \"$CP\" org.python.util.jython \"$@\"\n");
        return buffer.toString();
    }

    /**
     * placeholders:
     * 
     * @see getStartScript
     */
    private String getUnixJythoncTemplate() {
        StringBuffer buffer = getUnixHeaderTemplate();
        buffer.append("\"{3}/jython\" \"{3}/Tools/jythonc/jythonc.py\" \"$@\"\n");
        return buffer.toString();
    }

    /**
     * placeholders:
     * 
     * @see getStartScript
     */
    private StringBuffer getUnixHeaderTemplate() {
        StringBuffer buffer = new StringBuffer(1000);
        buffer.append("#!/bin/sh\n");
        buffer.append("\n");
        buffer.append("# This file was generated by the Jython installer\n");
        buffer.append("# Created on {0} by {1}\n");
        buffer.append("\n");
        return buffer;
    }

    /**
     * @param fileName The short file name, e.g. JYTHON_BAT
     * @param contents
     * 
     * @throws IOException
     */
    private File writeToFile(String fileName, String contents) throws IOException {
        File file = new File(_targetDirectory, fileName);
        if (file.exists()) {
            file.delete();
        }
        file.createNewFile();
        if (file.exists()) {
            if (file.canWrite()) {
                FileWriter fileWriter = new FileWriter(file);
                fileWriter.write(contents);
                fileWriter.flush();
                fileWriter.close();
            }
        }
        return file;
    }

    /**
     * do a chmod on the passed file
     * 
     * @param scriptFile
     */
    private void makeExecutable(File scriptFile) {
        try {
            String command = "chmod" + " " + EXECUTABLE_MODE + " " + scriptFile.getAbsolutePath();
            long timeout = 3000;
            ChildProcess childProcess = new ChildProcess(command, timeout);
            childProcess.run();
        } catch (Throwable t) {
            t.printStackTrace();
        }
    }

}